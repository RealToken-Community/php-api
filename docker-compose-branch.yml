services:
    symfony:
        image: ${DOCKER_REGISTRY}/api-php:${DOCKER_BRANCH}
        container_name: ${DOCKER_BRANCH}-api_php-sf
#        build:
#            context: ./
        build:
            context: .
            dockerfile: Dockerfile
            target: production
        environment:
            APP_ENV: ${APP_ENV}
            APP_DEBUG: ${APP_DEBUG:-0}
            DATABASE_URL: ${DATABASE_URL}
            REDIS_URL: redis://redis:6379
            SENTRY_DSN: ${SENTRY_DSN:-}
            API_TOKEN_CHECK_HEALTH: ${API_TOKEN_CHECK_HEALTH:-}
            EMAILING_ACCESS_TOKEN: ${EMAILING_ACCESS_TOKEN:-}
        networks:
            - api-php
            - traefik-realt
#        volumes:
#              - ./logs/symfony:/var/www/html/var/log:cached
#              - ./logs/nginx:/var/log/nginx:cached
        depends_on:
            db:
                condition: service_healthy
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.api-${DOCKER_BRANCH}.rule=Host(`${HOSTNAME}`)"
            - "traefik.http.services.api-${DOCKER_BRANCH}.loadbalancer.server.port=80"
        restart: always

    db:
        image: mysql:9.3
        container_name: ${DOCKER_BRANCH}-api_php-db
        networks:
            - api-php
        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
            MYSQL_USER: ${MYSQL_USER}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD}
            MYSQL_DATABASE: ${MYSQL_DATABASE}
        # Persistance des données MySQL : monte un volume nommé (par branche)
        volumes:
            - ${DOCKER_BRANCH}-api_mysql_data:/var/lib/mysql
        healthcheck:
            test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "--silent" ]
            interval: 5s
            timeout: 3s
            retries: 10
            start_period: 30s
        restart: always

    redis:
        image: redis:7-alpine
        container_name: ${DOCKER_BRANCH}-api_php-redis
#        ports:
#            - "6379:6379"
        networks:
            - api-php
        healthcheck:
            test: [ "CMD", "redis-cli", "ping" ]
            interval: 5s
            timeout: 3s
            retries: 5
        restart: always
        command: [ "redis-server", "--appendonly", "yes" ]

    redisinsight:
        image: redis/redisinsight:latest
        container_name: ${DOCKER_BRANCH}-api_php-redisinsight
        networks:
            - api-php
            - traefik-realt
        depends_on:
            redis:
                condition: service_healthy
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.redis-api-${DOCKER_BRANCH}.rule=Host(`redis.${HOSTNAME}`)"
            - "traefik.http.routers.redis-api-${DOCKER_BRANCH}.middlewares=auth@file"
        restart: unless-stopped

    adminer:
        image: adminer
        container_name: ${DOCKER_BRANCH}-api_php-adminer
        networks:
            - api-php
            - traefik-realt
        depends_on:
            db:
                condition: service_healthy
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.adminer-api-${DOCKER_BRANCH}.rule=Host(`adminer.${HOSTNAME}`)"
            - "traefik.http.routers.adminer-api-${DOCKER_BRANCH}.middlewares=auth@file"
        restart: unless-stopped

networks:
    api-php:
        name: ${DOCKER_NETWORK_NAME}
    traefik-realt:
        external: true

# Volume nommé pour persister les données MySQL entre les redéploiements
volumes:
    ${DOCKER_BRANCH}-api_mysql_data:
        driver: local
